// CK_SMC_ProfileLoader.mqh
#pragma once
string g_profileName    = "DEFAULT";
string g_profileVersion = "";
bool   g_profileLoaded  = false;
string LoadFileToString(const string fileName){int h = FileOpen(fileName, FILE_READ|FILE_TXT);if(h == INVALID_HANDLE) return "";string data="";while(!FileIsEnding(h)){string line=FileReadString(h);if(StringLen(line)>0)data+=line+"\n";}FileClose(h);return data;}
int FindKey(const string json,const string key){return StringFind(json,"\""+key+"\"");}
string ExtractRawValue(const string json,const string key){int pos=FindKey(json,key);if(pos<0) return "";int colon=StringFind(json,":",pos);if(colon<0) return "";int start=colon+1;while(start<StringLen(json)&&StringSubstr(json,start,1)="=" ) start++;string first=StringSubstr(json,start,1);int end=start;bool inString=(first=="\"");if(inString){end++;while(end<StringLen(json)){string ch=StringSubstr(json,end,1);if(ch=="\""&&StringSubstr(json,end-1,1)!="\\"){end++;break;}end++;}}else{while(end<StringLen(json)){string ch=StringSubstr(json,end,1);if(ch==","||ch=="}"||ch=="]"||ch=="\n"||ch=="\r") break;end++;}}string raw=StringSubstr(json,start,end-start);return StringTrim(raw);}double ExtractNumber(const string json,const string key,double def){string raw=ExtractRawValue(json,key);if(raw=="") return def;if(StringSubstr(raw,0,1)=="\"") raw=StringSubstr(raw,1,StringLen(raw)-2);raw=StringTrim(raw);if(StringLen(raw)==0) return def;return StrToDouble(raw);}bool ExtractBool(const string json,const string key,bool def){string raw=ExtractRawValue(json,key);raw=StringTrim(raw);if(raw=="true") return true;if(raw=="false") return false;return def;}string ExtractString(const string json,const string key,const string def){string raw=ExtractRawValue(json,key);if(raw=="") return def;if(StringSubstr(raw,0,1)=="\"") raw=StringSubstr(raw,1,StringLen(raw)-2);return raw;}string ExtractSection(const string json,const string sectionKey){int pos=StringFind(json,"\""+sectionKey+"\"");if(pos<0) return "";int brace=StringFind(json,"{",pos);if(brace<0) return "";int depth=0;for(int i=brace;i<StringLen(json);i++){string ch=StringSubstr(json,i,1);if(ch=="{") depth++;if(ch=="}"){depth--;if(depth==0)return StringSubstr(json,brace,i-brace+1);}}return "";}bool LoadProfileJSON(const string fileName,double &riskPercent,double &targetRR,double &partialTP_RR,bool &enablePartialTP,bool &enableStructureTrailing,double &newsRiskReductionPercent,int &maxBasePositions,int &maxTotalPositions,bool &portfolioThrottleOn,double &volHighThreshold,double &volLowRevertThreshold,double &obFvgOverlapMin,string symbols[],double symbolRiskPercent[],double symbolTargetRR[],double symbolPartialTP[],double symbolTrailAtrMult[],double symbolSlBuffer[],double symbolFvgMinGap[],int symbolLiqLookback[]){string json=LoadFileToString(fileName);if(json==""){Print("Profile NOT found: ",fileName);return false;}g_profileName=ExtractString(json,"profileName","UNKNOWN");g_profileVersion=ExtractString(json,"version","0.0");string globalSec=ExtractSection(json,"global");if(globalSec!=""){riskPercent=ExtractNumber(globalSec,"riskPercent",riskPercent);targetRR=ExtractNumber(globalSec,"targetRR",targetRR);partialTP_RR=ExtractNumber(globalSec,"partialTP_RR",partialTP_RR);enablePartialTP=ExtractBool(globalSec,"enablePartialTP",enablePartialTP);enableStructureTrailing=ExtractBool(globalSec,"enableStructureTrailing",enableStructureTrailing);newsRiskReductionPercent=ExtractNumber(globalSec,"newsRiskReductionPercent",newsRiskReductionPercent);maxBasePositions=(int)ExtractNumber(globalSec,"maxBasePositions",maxBasePositions);maxTotalPositions=(int)ExtractNumber(globalSec,"maxTotalPositions",maxTotalPositions);portfolioThrottleOn=ExtractBool(globalSec,"portfolioThrottleOn",portfolioThrottleOn);}string filtersSec=ExtractSection(json,"filters");if(filtersSec!=""){volHighThreshold=ExtractNumber(filtersSec,"volHighThreshold",volHighThreshold);volLowRevertThreshold=ExtractNumber(filtersSec,"volLowRevertThreshold",volLowRevertThreshold);obFvgOverlapMin=ExtractNumber(filtersSec,"obFvgOverlapMin",obFvgOverlapMin);}string symbolsSec=ExtractSection(json,"symbols");if(symbolsSec!=""){for(int i=0;i<ArraySize(symbols);i++){string sym=symbols[i];string sub=ExtractSection(symbolsSec,sym);if(sub=="") continue;symbolRiskPercent[i]=ExtractNumber(sub,"riskPercent",symbolRiskPercent[i]);symbolTargetRR[i]=ExtractNumber(sub,"targetRR",symbolTargetRR[i]);symbolPartialTP[i]=ExtractNumber(sub,"partialTP_RR",symbolPartialTP[i]);symbolTrailAtrMult[i]=ExtractNumber(sub,"trailAtrMult",symbolTrailAtrMult[i]);symbolSlBuffer[i]=ExtractNumber(sub,"slBufferPoints",symbolSlBuffer[i]);symbolFvgMinGap[i]=ExtractNumber(sub,"fvgMinGapPoints",symbolFvgMinGap[i]);symbolLiqLookback[i]=(int)ExtractNumber(sub,"liquidityLookback",symbolLiqLookback[i]);}}g_profileLoaded=true;Print("Profile loaded: ",g_profileName," v",g_profileVersion);return true;}